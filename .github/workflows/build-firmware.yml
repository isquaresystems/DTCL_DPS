name: Build Firmware

on:
  push:
    branches: [main, develop]
    paths:
      - 'Firmware/**'
      - '.github/workflows/build-firmware.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      dps3: ${{ steps.filter.outputs.dps3 }}
      dps2: ${{ steps.filter.outputs.dps2 }}
      dtcl: ${{ steps.filter.outputs.dtcl }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            dps3:
              - 'Firmware/DPS3/**'
            dps2:
              - 'Firmware/DPS2/**'
            dtcl:
              - 'Firmware/DTCL/**'

  build-dps3:
    needs: changes
    if: needs.changes.outputs.dps3 == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

      - name: Build DPS3 firmware
        working-directory: Firmware/DPS3/D3_DPS_4IN1
        run: make VERSION_MAJOR=1 VERSION_MINOR=0 clean all

  build-dps2:
    needs: changes
    if: needs.changes.outputs.dps2 == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

      - name: Build DPS2 firmware
        working-directory: Firmware/DPS2/D2_DPS_4IN1
        run: make VERSION_MAJOR=1 VERSION_MINOR=0 clean all

  build-dtcl:
    needs: changes
    if: needs.changes.outputs.dtcl == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

      - name: Build DTCL firmware
        working-directory: Firmware/DTCL
        run: make VERSION_MAJOR=3 VERSION_MINOR=6 clean all
