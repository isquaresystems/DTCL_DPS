name: Create Installer Release

on:
  workflow_dispatch:
    inputs:
      gui_version:
        description: 'GUI version (e.g., 1.3)'
        required: true
        default: '1.3'
      dps3_version:
        description: 'DPS3 firmware version (e.g., 1.1)'
        required: true
        default: '1.1'
      dps2_version:
        description: 'DPS2 firmware version (e.g., 1.1)'
        required: true
        default: '1.1'
      dtcl_version:
        description: 'DTCL firmware version (e.g., 3.6)'
        required: true
        default: '3.6'
      create_release:
        description: 'Create GitHub Release'
        type: boolean
        required: false
        default: true

jobs:
  build-dps3:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

      - name: Parse version
        id: ver
        run: |
          MAJOR=$(echo "${{ github.event.inputs.dps3_version }}" | cut -d. -f1)
          MINOR=$(echo "${{ github.event.inputs.dps3_version }}" | cut -d. -f2)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Build DPS3 firmware
        working-directory: Firmware/DPS3/D3_DPS_4IN1
        run: make VERSION_MAJOR=${{ steps.ver.outputs.major }} VERSION_MINOR=${{ steps.ver.outputs.minor }} clean all

      - name: Upload DPS3 ELF
        uses: actions/upload-artifact@v4
        with:
          name: DPS3-ELF
          path: Firmware/DPS3/D3_DPS_4IN1/build/*.elf
          retention-days: 1

  build-dps2:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

      - name: Parse version
        id: ver
        run: |
          MAJOR=$(echo "${{ github.event.inputs.dps2_version }}" | cut -d. -f1)
          MINOR=$(echo "${{ github.event.inputs.dps2_version }}" | cut -d. -f2)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Build DPS2 firmware
        working-directory: Firmware/DPS2/D2_DPS_4IN1
        run: make VERSION_MAJOR=${{ steps.ver.outputs.major }} VERSION_MINOR=${{ steps.ver.outputs.minor }} clean all

      - name: Upload DPS2 ELF
        uses: actions/upload-artifact@v4
        with:
          name: DPS2-ELF
          path: Firmware/DPS2/D2_DPS_4IN1/build/*.elf
          retention-days: 1

  build-dtcl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ARM toolchain
        run: sudo apt-get install -y gcc-arm-none-eabi binutils-arm-none-eabi

      - name: Parse version
        id: ver
        run: |
          MAJOR=$(echo "${{ github.event.inputs.dtcl_version }}" | cut -d. -f1)
          MINOR=$(echo "${{ github.event.inputs.dtcl_version }}" | cut -d. -f2)
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Build DTCL firmware
        working-directory: Firmware/DTCL
        run: make VERSION_MAJOR=${{ steps.ver.outputs.major }} VERSION_MINOR=${{ steps.ver.outputs.minor }} clean all

      - name: Upload DTCL ELF
        uses: actions/upload-artifact@v4
        with:
          name: DTCL-ELF
          path: Firmware/DTCL/build/*.elf
          retention-days: 1

  build-installer:
    runs-on: windows-latest
    needs: [build-dps3, build-dps2, build-dtcl]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup MSBuild
        uses: microsoft/setup-msbuild@v2

      - name: Setup NuGet
        uses: NuGet/setup-nuget@v2

      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          echo "C:\Program Files (x86)\Inno Setup 6" >> $GITHUB_PATH

      - name: Restore NuGet packages
        run: nuget restore DPS_DTCL/DTCL.sln

      - name: Build GUI
        run: |
          msbuild DPS_DTCL/DTCL.sln `
            /p:Configuration=Release `
            /p:Platform="Any CPU" `
            /v:minimal

      - name: Build TestConsole
        run: |
          msbuild TestConsole/TestConsole.csproj `
            /p:Configuration=Release `
            /p:Platform=AnyCPU `
            /v:minimal

      - name: Download DPS3 ELF
        uses: actions/download-artifact@v4
        with:
          name: DPS3-ELF
          path: installer/ELF

      - name: Download DPS2 ELF
        uses: actions/download-artifact@v4
        with:
          name: DPS2-ELF
          path: installer/ELF

      - name: Download DTCL ELF
        uses: actions/download-artifact@v4
        with:
          name: DTCL-ELF
          path: installer/ELF

      - name: Set version
        run: echo "VERSION=${{ github.event.inputs.gui_version }}" >> $env:GITHUB_ENV

      - name: Update version in Inno Setup script
        run: |
          (Get-Content installer/DTCL_DPS.iss) -replace '#define AppVersion ".*"', "#define AppVersion `"${{ env.VERSION }}`"" | Set-Content installer/DTCL_DPS.iss

      - name: Build Installer
        run: iscc installer/DTCL_DPS.iss

      - name: Create source zip
        run: git archive --format=zip --output="installer/output/DTCL_DPS_Source_v${{ env.VERSION }}.zip" HEAD

      - name: Verify installer was created
        run: |
          if (Test-Path "installer/output/DTCL_DPS_V${{ env.VERSION }}.exe") {
            echo "âœ“ Installer created successfully"
            $size = (Get-Item "installer/output/DTCL_DPS_V${{ env.VERSION }}.exe").Length / 1MB
            echo "Installer size: $([math]::Round($size, 2)) MB"
          } else {
            echo "âœ— Installer not found!"
            exit 1
          }

      - name: Create GitHub Release
        if: github.event.inputs.create_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: DTCL_DPS v${{ env.VERSION }}
          files: |
            installer/output/DTCL_DPS_V${{ env.VERSION }}.exe
            installer/output/DTCL_DPS_Source_v${{ env.VERSION }}.zip
          body: |
            ## DTCL_DPS v${{ env.VERSION }} - Windows Installer

            ### Versions
            - GUI: v${{ github.event.inputs.gui_version }}
            - DPS3 Firmware: v${{ github.event.inputs.dps3_version }}
            - DPS2 Firmware: v${{ github.event.inputs.dps2_version }}
            - DTCL Firmware: v${{ github.event.inputs.dtcl_version }}

            ### What's New
            See [commit history](https://github.com/${{ github.repository }}/commits/main) for changes.

            ### Installation
            1. Download `DTCL_DPS_V${{ env.VERSION }}.exe`
            2. Run the installer
            3. Follow the setup wizard

            **Requirements:**
            - Windows 10/11 (x64)
            - .NET Framework 4.8 (installer will check and prompt if missing)

            ### Features
            - DPS2 4IN1 (NAND Flash) support
            - DPS3 4IN1 (Compact Flash) support
            - DTCL Hybrid (2 slots: 1 D2 + 1 D3)
            - DPS MUX support (8 channels Ã— 4 slots)
            - TestConsole CLI tool included
            - Firmware ELF files included in `ELF\` folder

            ---
            ðŸ¤– Built with GitHub Actions using Inno Setup + arm-none-eabi-gcc
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Installer as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: DTCL_DPS_V${{ env.VERSION }}
          path: installer/output/DTCL_DPS_V${{ env.VERSION }}.exe
          retention-days: 90
